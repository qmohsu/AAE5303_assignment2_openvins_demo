# AAE5303 Assignment 2: OpenVINS Demo

[![ROS2 Humble](https://img.shields.io/badge/ROS2-Humble-blue)](https://docs.ros.org/en/humble/)
[![OpenVINS](https://img.shields.io/badge/OpenVINS-VIO-green)](https://docs.openvins.com/)
[![Python 3.8+](https://img.shields.io/badge/Python-3.8+-yellow)](https://www.python.org/)

This repository contains evaluation tools for Visual-Inertial Odometry (VIO) trajectories generated by [OpenVINS](https://github.com/rpng/open_vins) using the HKairport GNSS dataset.

## üìã Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Running OpenVINS](#running-openvins)
- [Recording Trajectory](#recording-trajectory)
- [Evaluation Tools](#evaluation-tools)
- [Output Files](#output-files)
- [Metrics Explained](#metrics-explained)
- [Troubleshooting](#troubleshooting)

## üéØ Overview

This project demonstrates:
1. Running OpenVINS with the HKairport GNSS dataset
2. Recording VIO trajectory data from ROS2 topics
3. Evaluating trajectory quality with comprehensive metrics
4. Visualizing results with 2D/3D plots

### System Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ROS2 Bag      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    OpenVINS     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Evaluation    ‚îÇ
‚îÇ  (HKairport)    ‚îÇ    ‚îÇ   (VIO Engine)  ‚îÇ    ‚îÇ    Script       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                      ‚îÇ                      ‚îÇ
        ‚îÇ                      ‚ñº                      ‚ñº
        ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ              ‚îÇ     RVIZ        ‚îÇ    ‚îÇ   Trajectory    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Visualization  ‚îÇ    ‚îÇ    Metrics      ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Prerequisites

### Docker Container
The project runs inside a Docker container with ROS2 Humble and OpenVINS pre-installed:

```bash
docker pull liangyu99/ros2_humble_dev:20251205
```

### Python Dependencies
```bash
pip install -r requirements.txt
```

Required packages:
- `numpy>=1.21.0`
- `matplotlib>=3.5.0`
- `scipy>=1.7.0`
- `pandas>=1.3.0`
- `PyYAML>=5.4.0`
- `transforms3d>=0.4.1`

## üöÄ Quick Start

### 1. Start the Docker Container

```bash
docker run -dit \
  --name ros2_humble_openvins \
  --privileged \
  --network=host \
  -e DISPLAY=$DISPLAY \
  -e QT_X11_NO_MITSHM=1 \
  -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
  -v /mnt/wslg:/mnt/wslg \
  -v $(pwd):/root/workspace \
  liangyu99/ros2_humble_dev:20251205
```

### 2. Enter the Container

```bash
docker exec -it ros2_humble_openvins bash
```

### 3. Source ROS2 Environment

```bash
source /opt/ros/humble/setup.bash
source /home/open_vins_ws/install/setup.bash
```

## üèÉ Running OpenVINS

### Step 1: Start the Image Decompressor

The HKairport bag contains compressed images that need to be decompressed:

```bash
ros2 run image_transport republish compressed raw \
  --ros-args \
  -r in/compressed:=/left_camera/image/compressed \
  -r out:=/left_camera/image_raw
```

### Step 2: Launch OpenVINS

```bash
ros2 launch ov_msckf subscribe.launch.py \
  config:=hkairport \
  max_cameras:=1 \
  use_stereo:=false \
  verbosity:=DEBUG
```

### Step 3: Launch RVIZ (Optional)

```bash
rviz2 -d /home/open_vins/config/hkairport/display.rviz
```

### Step 4: Play the ROS Bag

```bash
ros2 bag play /home/HKairport_GNSS03_ros2 --rate 0.5
```

## üìπ Recording Trajectory

### Using the Recorder Script

Record trajectory data while OpenVINS is running:

```bash
# Record for 60 seconds
python3 record_trajectory.py --duration 60 --output trajectory.txt

# Record until Ctrl+C
python3 record_trajectory.py --output trajectory.txt

# Record from specific topic
python3 record_trajectory.py --topic /ov_msckf/pathimu --output path.txt
```

### Available Topics

| Topic | Type | Description |
|-------|------|-------------|
| `/ov_msckf/odomimu` | `nav_msgs/Odometry` | Full odometry with covariance |
| `/ov_msckf/pathimu` | `nav_msgs/Path` | Accumulated path history |
| `/ov_msckf/poseimu` | `geometry_msgs/PoseWithCovarianceStamped` | Current pose |

### Output Format (TUM)

The trajectory is saved in TUM format:
```
# timestamp tx ty tz qx qy qz qw
1698218960.499885082 0.000373 0.013264 0.009647 -0.008096 0.001861 -0.999965 0.000689
1698218960.599971056 0.000874 0.015524 0.010169 -0.008233 0.001826 -0.999964 0.000747
...
```

## üìä Evaluation Tools

### Basic Evaluation

```bash
python3 evaluate_openvins.py --input trajectory.txt --output results/
```

### With Ground Truth Comparison

```bash
python3 evaluate_openvins.py \
  --input trajectory.txt \
  --groundtruth groundtruth.txt \
  --output results/
```

### Command Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `--input`, `-i` | Input trajectory file (TUM format) | Auto-detect |
| `--groundtruth`, `-g` | Ground truth file (TUM format) | None |
| `--output`, `-o` | Output directory | `./evaluation_results` |
| `--record` | Record from ROS2 topic | False |
| `--topic` | ROS2 topic for recording | `/ov_msckf/odomimu` |
| `--duration` | Recording duration (seconds) | 60.0 |

## üìÅ Output Files

After running the evaluation, you'll find:

```
evaluation_results/
‚îú‚îÄ‚îÄ evaluation_metrics.yaml    # All computed metrics
‚îú‚îÄ‚îÄ trajectory_2d.png          # 2D trajectory plots (XY, XZ, YZ)
‚îú‚îÄ‚îÄ trajectory_3d.png          # 3D trajectory visualization
‚îú‚îÄ‚îÄ position_components.png    # X, Y, Z over time
‚îî‚îÄ‚îÄ velocity_profile.png       # Velocity analysis
```

### Sample Metrics Output

```yaml
# Trajectory Statistics
total_distance: 1523.45
duration: 396.99
avg_velocity: 3.84
num_poses: 3971

# Drift Analysis
drift_total: 12.34
drift_per_meter: 0.81
drift_x: 5.67
drift_y: 8.91
drift_z: 2.34

# Relative Pose Error (RPE)
rpe_trans_rmse: 0.0234
rpe_rot_rmse: 0.156

# Velocity Analysis
vel_mean: 3.84
vel_max: 12.56
vel_std: 2.13
```

## üìà Metrics Explained

### Absolute Trajectory Error (ATE)

Measures the global consistency of the trajectory by comparing estimated poses with ground truth after alignment.

$$\text{ATE}_{\text{RMSE}} = \sqrt{\frac{1}{N}\sum_{i=1}^{N}\|p_i^{est} - p_i^{gt}\|^2}$$

### Relative Pose Error (RPE)

Measures local accuracy by comparing relative motion over fixed time intervals.

$$\text{RPE}_{\text{trans}} = \|(T_i^{-1}T_j)^{est} - (T_i^{-1}T_j)^{gt}\|_{trans}$$

### Drift Metrics

- **Total Drift**: Distance between start and end positions
- **Drift per Meter**: Drift normalized by total distance traveled (%)

### Velocity Analysis

- **Mean Velocity**: Average speed throughout the trajectory
- **Max Velocity**: Peak speed detected
- **Velocity Std**: Consistency of motion

## üîç Troubleshooting

### OpenVINS Not Initializing

**Symptoms**: No output from OpenVINS, stuck at "waiting for data"

**Solutions**:
1. Check if image decompressor is running
2. Verify bag is playing: `ros2 topic hz /left_camera/image_raw`
3. Ensure IMU data is available: `ros2 topic hz /dji_osdk_ros/imu`

### RVIZ Display Issues

**Symptoms**: Black screen or no visualization

**Solutions**:
1. Check X11 forwarding: `echo $DISPLAY`
2. Allow X server connections: `xhost +local:docker`
3. Verify container has display access

### No Trajectory Data

**Symptoms**: Recorder shows 0 poses

**Solutions**:
1. Verify OpenVINS is publishing: `ros2 topic echo /ov_msckf/odomimu`
2. Check topic name matches
3. Ensure OpenVINS has initialized (needs motion for initialization)

### Import Errors

**Symptoms**: `ModuleNotFoundError`

**Solutions**:
```bash
pip install -r requirements.txt
```

## üìö References

- [OpenVINS Documentation](https://docs.openvins.com/)
- [TUM Trajectory Format](https://vision.in.tum.de/data/datasets/rgbd-dataset/file_formats)
- [ROS2 Humble Documentation](https://docs.ros.org/en/humble/)

## üìÑ License

This project is for educational purposes as part of AAE5303 coursework.

## üë• Contributors

- AAE5303 Course Assignment 2
- December 2024

